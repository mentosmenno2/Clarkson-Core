<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WP Hookdoc: Source: lib/clarkson-core-gutenberg-block-manager.php</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/clarkson-core-gutenberg-block-manager.php</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Integrates Clarkson and Gutenberg to allow for twig rendering of blocks.
 *
 * @package CLARKSON\Lib
 * @since 0.4.0
 */

/**
 * Intercepts 'the content' filter to allow overriding of the rendering functions
 * of Gutenberg blocks. This allows us to use twig for block rendering.
 */
class Clarkson_Core_Gutenberg_Block_Manager {
	/**
	 * Hook in as soon as we can, to replace blocks with the Clarkson-block equivalent.
	 * @internal
	 */
	public function init() {
		if ( class_exists( '\WP_Block_Type_Registry' ) ) {
			add_filter( 'the_content', array( $this, 'intercept_gutenberg_rendering' ), 1 );
		}
	}

	/**
	 * Attempts to create a custom block from class from a block. Falls back
	 * to a default Clarkson Core block type.
	 *
	 * @param \WP_Block_type $block_type Gutenberg block to determine class for.
	 * @return string
	 */
	public function determine_block_type_class( $block_type ) {
		$class_name = '\\Gutenberg\\Blocks\\' . $this->sanitize_block_type_name( $block_type->name );

		/**
		 * Allows the theme to overwrite the class loaded by Clarkson Core.
		 *
		 * @hook clarkson_core_gutenberg_block_class
		 * @since 0.4.0
		 * @param {string} $class_name Name of a calculated class that Clarkson Core would load for this block.
		 * @param {WP_Block_type} $block_type The WordPress block that generates the content.
		 * @return {string} Class name of object to load for this block.
		 *
		 * @example
		 * // Change default block class.
		 * add_filter( 'clarkson_core_gutenberg_block_class', function( $class_name ){
		 *  if ( ! class_exists( $class_name ) ) {
		 *      return '\CustomDefaultBlock';
		 *  }
		 *  return $class_name;
		 * } );
		 */
		$class_name = apply_filters( 'clarkson_core_gutenberg_block_class', $class_name, $block_type );

		/**
		 * Allows the theme to overwrite the class loaded by Clarkson Core.
		 *
		 * @hook clarkson_core_gutenberg_block_class_{$name}
		 * @since 0.4.0
		 * @param {string} $class_name Name of a calculated class that Clarkson Core would load for this block.
		 * @param {WP_Block_type} $block_type The WordPress block that generates the content.
		 * @return {string} Classname of object to load for this block.
		 */
		$class_name = apply_filters( 'clarkson_core_gutenberg_block_class_' . $block_type->name, $class_name, $block_type );
		if ( class_exists( $class_name ) ) {
			return $class_name;
		}
		return '\Clarkson_Core_Gutenberg_Block_Type';
	}

	/**
	 * Filters a block name into a valid class name.
	 *
	 * @param string $str Classname to be sanitized.
	 * @return string
	 */
	public function sanitize_block_type_name( $str ) {
		$str = trim( $str );

		// Replace - with _ .
		// Non-alpha and non-numeric characters become underscores.
		// We can't run `new ll-events()` because that's an invalid class name.
		$str = preg_replace( '/[^a-z0-9]+/i', '_', $str );

		// String to lowercase is require by post-type naming convention.
		// See https://codex.wordpress.org/Function_Reference/register_post_type#post_type.
		$str = strtolower( $str );

		return $str;
	}

	/**
	 * Replaces all registered non-core blocks with our intermediate class, so we
	 * can manipulate the rendering function.
	 *
	 * Does not manipulate the $content.
	 *
	 * @param $content string The content string to be ouputted. Not manipulated
	 * at this stage.
	 * @return string
	 *
	 * @internal
	 */
	public function intercept_gutenberg_rendering( $content ) {
		$block_registry = \WP_Block_Type_Registry::get_instance();
		foreach ( $block_registry->get_all_registered() as $original_block ) {
			$block_type     = $this->determine_block_type_class( $original_block );
			$clarkson_block = new $block_type( $original_block->name, get_object_vars( $original_block ) );
			$block_registry->unregister( $original_block );
			$block_registry->register( $clarkson_block );
		}
		return $content;
	}
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Filters</h3><ul><li><a href="clarkson_available_objects.html">clarkson_available_objects</a></li><li><a href="clarkson_available_objects_paths.html">clarkson_available_objects_paths</a></li><li><a href="clarkson_context_args.html">clarkson_context_args</a></li><li><a href="clarkson_core_autoload_dirs.html">clarkson_core_autoload_dirs</a></li><li><a href="clarkson_core_autoload_theme_pre_020.html">clarkson_core_autoload_theme_pre_020</a></li><li><a href="clarkson_core_available_templates.html">clarkson_core_available_templates</a></li><li><a href="clarkson_core_create_object_callback.html">clarkson_core_create_object_callback</a></li><li><a href="clarkson_core_deprecated_warning_page_template.html">clarkson_core_deprecated_warning_page_template</a></li><li><a href="clarkson_core_gutenberg_block_class.html">clarkson_core_gutenberg_block_class</a></li><li><a href="clarkson_core_gutenberg_block_class_%257B$name%257D.html">clarkson_core_gutenberg_block_class_{$name}</a></li><li><a href="clarkson_core_gutenberg_block_template_directory.html">clarkson_core_gutenberg_block_template_directory</a></li><li><a href="clarkson_core_gutenberg_block_template_%257B$name%257D.html">clarkson_core_gutenberg_block_template_{$name}</a></li><li><a href="clarkson_core_template_paths.html">clarkson_core_template_paths</a></li><li><a href="clarkson_core_templates_types_for_%257B$name%257D.html">clarkson_core_templates_types_for_{$name}</a></li><li><a href="clarkson_object_type.html">clarkson_object_type</a></li><li><a href="clarkson_twig_args.html">clarkson_twig_args</a></li><li><a href="clarkson_twig_functions.html">clarkson_twig_functions</a></li><li><a href="clarkson_twig_stylesheet_dir.html">clarkson_twig_stylesheet_dir</a></li><li><a href="clarkson_twig_template_dir.html">clarkson_twig_template_dir</a></li><li><a href="clarkson_twig_template_dirs.html">clarkson_twig_template_dirs</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
